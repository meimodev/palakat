# Implementation Plan

- [x] 1. Backend: Create FinancialAccountNumber model and database schema
  - [x] 1.1 Add FinancialAccountNumber model to Prisma schema
    - Add model with id, accountNumber, description, churchId, createdAt, updatedAt fields
    - Add many-to-one relationship with Church
    - Add unique constraint on [churchId, accountNumber]
    - Add indexes for churchId and accountNumber
    - _Requirements: 2.1, 2.2_
  - [x] 1.2 Update Revenue model with optional FinancialAccountNumber relationship
    - Add financialAccountNumberId field (optional, unique)
    - Add financialAccountNumber relation
    - Keep existing accountNumber string field for backward compatibility
    - _Requirements: 2.3_
  - [x] 1.3 Update Expense model with optional FinancialAccountNumber relationship
    - Add financialAccountNumberId field (optional, unique)
    - Add financialAccountNumber relation
    - Keep existing accountNumber string field for backward compatibility
    - _Requirements: 2.4_
  - [x] 1.4 Update Church model with FinancialAccountNumber relation
    - Add financialAccountNumbers relation array
    - _Requirements: 2.2_
  - [x] 1.5 Run Prisma migration
    - Generate and apply database migration
    - _Requirements: 2.1_

- [x] 2. Backend: Create FinancialAccountNumber NestJS module
  - [x] 2.1 Create DTOs for FinancialAccountNumber
    - Create CreateFinancialAccountNumberDto with accountNumber (required) and description (optional)
    - Create UpdateFinancialAccountNumberDto as partial of create DTO
    - Create FindAllDto extending PaginationDto with search parameter
    - _Requirements: 5.2, 5.3, 5.5_
  - [x] 2.2 Create FinancialAccountNumber service
    - Implement findAll with pagination and search filtering
    - Implement findOne by id
    - Implement create with uniqueness validation
    - Implement update
    - Implement remove with in-use check
    - _Requirements: 2.5, 2.6, 5.1, 5.2, 5.3, 5.4, 5.5_
  - [x] 2.3 Create FinancialAccountNumber controller
    - Implement GET /financial-account-number with pagination and search
    - Implement GET /financial-account-number/:id
    - Implement POST /financial-account-number
    - Implement PATCH /financial-account-number/:id
    - Implement DELETE /financial-account-number/:id
    - Add JwtAuthGuard to all endpoints
    - _Requirements: 5.1, 5.2, 5.3, 5.4, 5.5_
  - [x] 2.4 Create FinancialAccountNumber module and register in AppModule
    - Create module with controller, service, and PrismaModule import
    - Register module in app.module.ts
    - _Requirements: 5.1_
  - [x] 2.5 Write property test: Create-Read Round Trip
    - **Property 1: Create-Read Round Trip**
    - **Validates: Requirements 1.3, 5.2**
  - [x] 2.6 Write property test: Delete Removes Record
    - **Property 2: Delete Removes Record**
    - **Validates: Requirements 1.5, 5.4**
  - [x] 2.7 Write property test: Uniqueness Within Church
    - **Property 4: Uniqueness Within Church**
    - **Validates: Requirements 2.5**
  - [x] 2.8 Write property test: Search Filter Correctness
    - **Property 5: Search Filter Correctness**
    - **Validates: Requirements 2.6, 5.5**

- [x] 3. Checkpoint - Ensure backend tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Shared Package: Create FinancialAccountNumber model
  - [x] 4.1 Create FinancialAccountNumber Freezed model
    - Create model in packages/palakat_shared/lib/core/models/
    - Add id, accountNumber, description, churchId, createdAt, updatedAt fields
    - Add JSON serialization
    - _Requirements: 3.4_
  - [x] 4.2 Export model from models barrel file
    - Add export to packages/palakat_shared/lib/models.dart
    - _Requirements: 3.4_
  - [x] 4.3 Run code generation
    - Run build_runner to generate Freezed and JSON serialization code
    - _Requirements: 3.4_

- [x] 5. Admin Panel: Create Financial feature module
  - [x] 5.1 Create FinancialAccountRepository
    - Create repository in lib/features/financial/data/
    - Implement getAll, getById, create, update, delete methods
    - Use ApiService for HTTP requests
    - _Requirements: 1.1, 1.3, 1.4, 1.5_
  - [x] 5.2 Create FinancialAccountListController and State
    - Create Freezed state with accounts list, loading, error fields
    - Create Riverpod controller with fetch, delete methods
    - _Requirements: 1.1, 1.5_
  - [x] 5.3 Create FinancialAccountListScreen
    - Create screen with DataTable showing account number, description, created date
    - Add "Add Account Number" button
    - Add edit and delete actions for each row
    - _Requirements: 1.1, 1.2, 1.4, 1.5, 1.6_
  - [ ]* 5.4 Write property test: List Display Completeness
    - **Property 9: List Display Completeness**
    - **Validates: Requirements 1.6**
  - [x] 5.5 Create FinancialAccountFormDialog
    - Create dialog with account number and description text fields
    - Support both create and edit modes
    - Add validation for required account number field
    - _Requirements: 1.2, 1.3, 1.4_
  - [x] 5.6 Add Financial menu to sidebar
    - Add _NavItem for Financial under Administration section
    - Route to /financial path
    - _Requirements: 1.1_
  - [x] 5.7 Add routing for Financial screens
    - Add /financial route to GoRouter configuration
    - _Requirements: 1.1_

- [ ] 6. Checkpoint - Ensure admin panel builds and runs
  - Ensure all tests pass, ask the user if questions arise.

- [x] 7. Mobile App: Create AccountNumberPicker widget
  - [x] 7.1 Create FinancialAccountRepository for mobile app
    - Create repository in lib/features/finance/data/
    - Implement getAll method with search parameter
    - _Requirements: 3.2, 3.3_
  - [x] 7.2 Create AccountNumberPicker widget
    - Create widget that displays selected account or placeholder
    - Show account number prominently with description below when selected
    - Handle tap to open picker dialog
    - _Requirements: 3.1, 3.4_
  - [x] 7.3 Create AccountNumberPickerDialog
    - Create dialog with search text field
    - Display scrollable list of account numbers
    - Filter results as user types in search field
    - Show "No results found" when search returns empty
    - _Requirements: 3.2, 3.3, 3.5_
  - [ ]* 7.4 Write property test: Account Number Picker Filter
    - **Property 7: Account Number Picker Filter**
    - **Validates: Requirements 3.3**

- [x] 8. Mobile App: Update Finance Create Screen
  - [x] 8.1 Replace account number text input with AccountNumberPicker
    - Remove InputWidget<String>.text for account number
    - Add AccountNumberPicker widget
    - Update controller to handle FinancialAccountNumber selection
    - _Requirements: 3.1, 3.4_
  - [x] 8.2 Update FinanceCreateState to include selected account
    - Add selectedFinancialAccountNumber field to state
    - Update validation to check for selected account
    - _Requirements: 3.1_
  - [x] 8.3 Update FinanceCreateController
    - Add onSelectedFinancialAccountNumber method
    - Update getFinanceData to include selected account number
    - Update validation logic
    - _Requirements: 3.1, 4.2, 4.3_
  - [x] 8.4 Improve confirm button UX in embedded mode
    - Ensure button text clearly indicates "Add Revenue" or "Add Expense"
    - Make button prominent and always visible at bottom
    - _Requirements: 4.1, 4.4_
  - [ ]* 8.5 Write property test: Form Validation and Submission
    - **Property 8: Form Validation and Submission**
    - **Validates: Requirements 4.2, 4.3**

- [x] 9. Mobile App: Update related code to use new account number picker
  - [x] 9.1 Update FinanceData model if needed
    - Ensure FinanceData can hold financialAccountNumberId
    - Update serialization
    - _Requirements: 3.4_
  - [x] 9.2 Update activity publish flow
    - Ensure attached finance data includes selected account number
    - _Requirements: 4.2_

- [x] 10. Backend: Update Revenue and Expense services
  - [x] 10.1 Update Revenue service to handle financialAccountNumberId
    - Accept optional financialAccountNumberId in create/update
    - Populate accountNumber string from FinancialAccountNumber if provided
    - _Requirements: 2.3_
  - [x] 10.2 Update Expense service to handle financialAccountNumberId
    - Accept optional financialAccountNumberId in create/update
    - Populate accountNumber string from FinancialAccountNumber if provided
    - _Requirements: 2.4_
  - [ ]* 10.3 Write property test: Optional Relationship Linking
    - **Property 6: Optional Relationship Linking**
    - **Validates: Requirements 2.3, 2.4**

- [ ] 11. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
