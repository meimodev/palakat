# Implementation Plan

- [x] 1. Create Finance Models and Enums in palakat_shared
  - [x] 1.1 Create PaymentMethod enum
    - Add `payment_method.dart` in `packages/palakat_shared/lib/core/models/`
    - Define CASH and CASHLESS values with JSON serialization
    - Export from models barrel file
    - Run code generation with `derry gen`
    - _Requirements: 2.4, 3.4_
  - [x] 1.2 Create Revenue model
    - Add `revenue.dart` with Freezed model
    - Include id, accountNumber, amount, churchId, activityId, paymentMethod, timestamps
    - Add JSON serialization
    - Export from models barrel file
    - _Requirements: 2.1_
  - [x] 1.3 Create Expense model
    - Add `expense.dart` with Freezed model
    - Include same fields as Revenue
    - Add JSON serialization
    - Export from models barrel file
    - _Requirements: 3.1_
  - [x] 1.4 Create CreateRevenueRequest and CreateExpenseRequest
    - Add request models for API calls
    - Include accountNumber, amount, churchId, activityId (optional), paymentMethod
    - _Requirements: 2.5, 3.5, 4.4_
  - [x] 1.5 Create FinanceType enum and FinanceData model
    - Add `finance_type.dart` with revenue/expense enum and display extensions
    - Add `finance_data.dart` Freezed model for data transfer between screens
    - _Requirements: 1.2, 1.3_

- [x] 2. Create Finance Repositories in palakat_shared
  - [x] 2.1 Create RevenueRepository
    - Add `revenue_repository.dart` with abstract class and implementation
    - Implement `createRevenue` method calling POST /revenue
    - Add Riverpod provider
    - _Requirements: 4.4, 5.2_
  - [x] 2.2 Create ExpenseRepository
    - Add `expense_repository.dart` with abstract class and implementation
    - Implement `createExpense` method calling POST /expense
    - Add Riverpod provider
    - _Requirements: 4.4, 5.2_

- [ ] 3. Checkpoint - Ensure code generation passes
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Create FinanceCreateScreen state and controller
  - [x] 4.1 Create FinanceCreateState
    - Add state file in `apps/palakat/lib/features/finance/presentations/finance_create/`
    - Define fields: financeType, isStandalone, amount, accountNumber, paymentMethod, selectedActivity
    - Add error fields and UI state (loading, isFormValid, errorMessage)
    - Run code generation
    - _Requirements: 2.1, 3.1, 4.1, 6.1, 6.2_
  - [x] 4.2 Create FinanceCreateController
    - Implement validation methods: validateAmount, validateAccountNumber, validatePaymentMethod, validateActivity
    - Implement onChange handlers for all fields
    - Implement validateForm method
    - Implement submit method for standalone mode (API call)
    - Implement getFinanceData method for embedded mode (return data)
    - _Requirements: 2.2, 2.3, 2.5, 3.2, 3.3, 3.5, 4.4, 6.2_
  - [ ]* 4.3 Write property test for amount validation
    - **Property 5: Amount validation correctness**
    - **Validates: Requirements 2.2, 3.2**
  - [ ]* 4.4 Write property test for account number validation
    - **Property 6: Account number validation correctness**
    - **Validates: Requirements 2.3, 3.3**
  - [ ]* 4.5 Write property test for finance data return completeness
    - **Property 7: Finance data return completeness**
    - **Validates: Requirements 2.5, 3.5**

- [x] 5. Create FinanceCreateScreen UI
  - [x] 5.1 Create finance_create_screen.dart
    - Follow ActivityPublishScreen design pattern
    - Build header with back button and title (Create Revenue / Create Expense)
    - Build finance type indicator badge
    - Build form section with amount, account number, payment method inputs
    - Conditionally show Activity Picker for standalone mode
    - Build submit button with loading state
    - _Requirements: 2.1, 3.1, 4.1, 6.1, 6.2, 6.3_
  - [x] 5.2 Create currency input widget with Rupiah formatting
    - Format display as "Rp X.XXX.XXX" while storing raw integer
    - Handle input parsing and formatting
    - _Requirements: 6.4_
  - [ ]* 5.3 Write property test for currency formatting
    - **Property 14: Currency formatting correctness**
    - **Validates: Requirements 6.4**
  - [x] 5.4 Create PaymentMethodPicker widget
    - Display CASH and CASHLESS options as selectable cards
    - Show selected state with visual feedback
    - _Requirements: 2.4, 3.4_

- [x] 6. Create ActivityPicker widget
  - [x] 6.1 Create ActivityPickerWidget
    - Display placeholder when no activity selected
    - Display selected activity info (title, date, type)
    - Handle tap to open activity selection dialog
    - _Requirements: 4.1, 4.3_
  - [x] 6.2 Create ActivityPickerDialog
    - Fetch supervised activities using existing ActivityRepository
    - Display searchable list of activities
    - Handle activity selection and return
    - _Requirements: 4.2_
  - [ ]* 6.3 Write property test for selected activity display
    - **Property 9: Selected activity display correctness**
    - **Validates: Requirements 4.3**

- [ ] 7. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 8. Create FinanceTypePicker dialog
  - [x] 8.1 Create finance_type_picker_dialog.dart
    - Display Revenue and Expense options as cards
    - Show icon, label, and description for each option
    - Return selected FinanceType on tap
    - _Requirements: 1.2_

- [x] 9. Create FinanceSummaryCard widget
  - [x] 9.1 Create finance_summary_card.dart
    - Display finance type badge (Revenue/Expense with color)
    - Display formatted amount with Rupiah formatting
    - Display account number and payment method
    - Add edit and remove action buttons
    - _Requirements: 1.4, 1.5_
  - [ ]* 9.2 Write property test for attached finance display completeness
    - **Property 3: Attached finance data display completeness**
    - **Validates: Requirements 1.4**

- [x] 10. Integrate Finance into ActivityPublishScreen
  - [x] 10.1 Extend ActivityPublishState with attachedFinance field
    - Add `FinanceData? attachedFinance` field
    - Run code generation
    - _Requirements: 1.4, 5.1_
  - [x] 10.2 Extend ActivityPublishController with finance methods
    - Add `onAttachedFinance(FinanceData?)` method
    - Add `removeAttachedFinance()` method
    - Modify `submit()` to create finance record after activity creation
    - _Requirements: 1.4, 1.5, 5.1, 5.2, 5.3, 5.4_
  - [ ]* 10.3 Write property test for finance removal clears state
    - **Property 4: Finance removal clears state**
    - **Validates: Requirements 1.5**
  - [ ]* 10.4 Write property test for combined creation order
    - **Property 11: Combined creation order and ID passing**
    - **Validates: Requirements 5.1, 5.2**
  - [x] 10.5 Add Financial Record section to ActivityPublishScreen
    - Add section after Schedule section for service/event types
    - Show "Add Financial Record" button when no finance attached
    - Show FinanceSummaryCard when finance is attached
    - Handle navigation to FinanceCreateScreen and result handling
    - _Requirements: 1.1, 1.2, 1.3, 1.4, 1.5_
  - [ ]* 10.6 Write property test for financial section visibility
    - **Property 1: Financial section visibility by activity type**
    - **Validates: Requirements 1.1**

- [x] 11. Add routing for Finance screens
  - [x] 11.1 Add route constants to AppRoute
    - Add `financeCreate` route constant
    - _Requirements: 1.3, 4.1_
  - [x] 11.2 Register routes in operations_routing.dart
    - Add GoRoute for finance-create with financeType and isStandalone parameters
    - Handle RouteParam for passing parameters
    - _Requirements: 1.3, 4.1_
  - [ ]* 11.3 Write property test for finance type navigation
    - **Property 2: Finance type navigation correctness**
    - **Validates: Requirements 1.3**

- [ ] 12. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 13. Add standalone Finance access point
  - [x] 13.1 Add Finance option to Operations screen or menu
    - Add navigation entry point for standalone finance creation
    - Navigate to FinanceTypePicker then FinanceCreateScreen with isStandalone=true
    - _Requirements: 4.1_

- [ ] 14. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

